<!DOCTYPE html><html><head><title>Are Kotlin List Operators Efficient? â€” Cody Sehl </title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/app.css"><script type="text/javascript" src="/js/ga.js"></script><script type="text/javascript" src="//use.typekit.net/fjx5dfz.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script><link rel="stylesheet" href="/css/prism.css"><script type="text/javascript" src="/js/prism.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><nav><ul><li><a target="_blank" rel="noopener" href="http://codysehl.net/">About</a></li><li><a target="_blank" rel="noopener" href="http://codysehl.net/work">Work</a></li><li><a href="http://blog.codysehl.net">Blog</a></li></ul></nav></body></html><div class="blog single-post-page"><div class="sidebar"><ul><li><a href="http://blog.codysehl.net">Recent Posts</a><li><a href="http://blog.codysehl.net/tags/Software/">Software</a></li><li><a href="http://blog.codysehl.net/tags/Android/">Android</a></li><li><a href="http://blog.codysehl.net/tags/Profound-Materials/">Profound Materials</a></li><li><a href="http://blog.codysehl.net/tags/Videos/">Videos</a></li><li><a href="http://blog.codysehl.net/tags/Books/">Books</a></li><li><a href="http://blog.codysehl.net/tags/Reviews/">Reviews</a></li><li><a href="http://blog.codysehl.net/tags/Philosophy/">Philosophy</a></li><li><a href="http://blog.codysehl.net/tags/Startup-Term/">Startup Term</a></li><li><a href="http://blog.codysehl.net/tags/iOS/">iOS</a></li><li><a href="http://blog.codysehl.net/tags/Testing/">Testing</a></li><li><a href="http://blog.codysehl.net/tags/Kotlin/">Kotlin</a></li><li><a href="http://blog.codysehl.net/tags/Interviewing/">Interviewing</a></li></li></ul></div><div class="sidebar-wrap"><div class="single-post"><h2 class="header">Are Kotlin List Operators Efficient?</h2><h3 class="date">August 18th, 2018</h3><div class="content"><p>Well, that depends on what you mean by <em>efficient</em>!</p>
<p>Let's start by exploring some ways list operators (map, filter, reduce and their ilk) might work.</p>
<p>An example:</p>
<pre class="lang-kotlin"><code>val numbers = listOf(1, 2, 3, 4, 5, 6)
val evenNumbers = list.filter &#123; num -&gt; num % 2 == 0 &#125; // 2, 4, 6
val evenNumbersDoubled = evenNumbers.map &#123; num -&gt; num * 2 &#125; // 4, 8, 12
val sum = evenNumbersDoubled.reduce &#123; sum, num -&gt; sum + num &#125; // 24</code></pre>
<p>In this example, we're given a list of numbers, find the even ones, double those, then sum the whole thing. Each step is broken out into a variable so that every operation has a name.</p>
<p>Here's a more concise version, closer to how this would probably be written in production:</p>
<pre class="lang-kotlin"><code>listOf(1, 2, 3, 4, 5, 6)
  .filter &#123; num -&gt; num % 2 == 0 &#125; // 2, 4, 6
  .map &#123; num -&gt; num * 2 &#125; // 4, 8, 12
  .reduce &#123; sum, num -&gt; sum + num &#125; // 24</code></pre>
<p>Given the above, I can conceive of two reasonable ways this code looks under the hood: (in pseudo-Java for simplicity)</p>
<h3 id="a-loop-for-every-operator">A loop for every operator</h3>
<pre class="lang-kotlin"><code>list = [1, 2, 3, 4, 5, 6]

// Filter
evenNumbers = []
for(i=0; i&lt;list.length, i++) &#123;
  num = list[i]
  if(num % 2 == 0) &#123;
    evenNumbers.add(num)
  &#125;
&#125;

// Map
evenNumbersDoubled = []
for(i=0; i&lt;evenNumbers.length, i++) &#123;
  num = evenNumbers[i]
  transformedResult = num * 2
  evenNumbersDoubled.add(transformedResult)
&#125;

// Reduce
sum = 0
for(i=0; i&lt;evenNumbersDoubled.length, i++) &#123;
  num = evenNumbersDoubled[i]
  sum = sum + num
&#125;</code></pre>
<p>With this method, the list is iterated over three times.</p>
<h3 id="many-operators-one-loop">Many operators, one loop</h3>
<pre class="lang-kotlin"><code>list = [1, 2, 3, 4, 5, 6]

sum = 0
evenNumbers = []
for(i=0; i&lt;list.length, i++) &#123;
  num = list[i]

  // Filter
  if(num % 2 == 0) &#123;

    // Map
    num = num * 2

    // Reduce
    sum = sum + num
  &#125;
&#125;</code></pre>
<p>With this method, the list is iterated over one time.</p>
<h2 id="which-way-does-kotlin-do-it">Which way does Kotlin do it?</h2>
<p>Now that we've established two possible ways list operators could work, which way does Kotlin choose?</p>
<p>Let's look at the source for map, filter, and reduce!</p>
<p><em>(You probably don't want to follow the links - the files are thousands of lines long.)</em></p>
<h3 id="map">Map</h3>
<p>The <a target="_blank" rel="noopener" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/map.html">source</a> takes us to <a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin/blob/1.2.60/libraries/stdlib/common/src/generated/_Arrays.kt#L8225">_Arrays.kt:8255</a>, which uses <code>mapTo</code> defined on line <a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin/blob/1.2.60/libraries/stdlib/common/src/generated/_Arrays.kt#L8542">8542</a>.</p>
<p>Here's the implementation for <code>mapTo</code>:</p>
<pre class="lang-kotlin"><code>public inline fun &lt;T, R, C : MutableCollection&lt;in R&gt;&gt; Array&lt;out T&gt;.mapTo(destination: C, transform: (T) -&gt; R): C &#123;
  for (item in this)
    destination.add(transform(item))
  return destination
&#125;</code></pre>
<h3 id="filter">Filter</h3>
<p>The <a target="_blank" rel="noopener" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/filter.html">source</a> takes us to <a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin/blob/1.2.60/libraries/stdlib/common/src/generated/_Arrays.kt#L3000">_Arrays.kt:3000</a>, which uses <code>filterTo</code> defined on line <a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin/blob/1.2.60/libraries/stdlib/common/src/generated/_Arrays.kt#L3417">3417</a>.</p>
<p>Here's the implementation for <code>filterTo</code>:</p>
<pre class="lang-kotlin"><code>public inline fun &lt;T, C : MutableCollection&lt;in T&gt;&gt; Array&lt;out T&gt;.filterTo(destination: C, predicate: (T) -&gt; Boolean): C &#123;
  for (element in this) if (predicate(element)) destination.add(element)
  return destination
&#125;</code></pre>
<h3 id="reduce">Reduce</h3>
<p>The <a target="_blank" rel="noopener" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/reduce.html">source</a> takes us to <a target="_blank" rel="noopener" href="https://github.com/JetBrains/kotlin/blob/1.2.60/libraries/stdlib/common/src/generated/_Arrays.kt#L11384">_Arrays.kt:11384</a>.</p>
<p><em>Note: Reduce does the same thing as Fold, except the initial value of the accumulator is the first element in the given list</em></p>
<p>Here's the implementation for <code>reduce</code>:</p>
<pre class="lang-kotlin"><code>public inline fun &lt;S, T : S&gt; Array&lt;out T&gt;.reduce(operation: (acc: S, T) -&gt; S): S &#123;
  if (isEmpty())
    throw UnsupportedOperationException(&quot;Empty array can&#39;t be reduced.&quot;)
  var accumulator: S = this[0]
  for (index in 1..lastIndex) &#123;
    accumulator = operation(accumulator, this[index])
  &#125;
  return accumulator
&#125;</code></pre>
<p>As we can see, map, filter, and reduce all use the <code>A loop for every operator</code> method, rather than queuing up the operations and using the <code>Many operators, one loop</code> method.</p>
<h2 id="are-kotlin-list-operators-efficient">Are Kotlin list operators efficient?</h2>
<p>So we're back to our main question - are these operators efficient? I'll define the word <code>efficient</code> in this context to mean using the <code>Many operators, one loop</code> method.</p>
<p>Then clearly, no! Kotlin list operators are not efficient.</p>
<h2 id="why-not">Why not?</h2>
<p>Language implementers tend to be pretty sharp folks and it's unlikely they've never thought of the scenario I described above.</p>
<p>Let's partake in some <a target="_blank" rel="noopener" href="https://www.google.com/search?q=apologetics&amp;oq=apologetics&amp;aqs=chrome..69i57j0l5.1969j0j7&amp;sourceid=chrome&amp;ie=UTF-8">apologetics</a> and think about why Kotlin's list operators were implemented this way - there's probably a reason!</p>
<h3 id="impure-functions">Impure functions</h3>
<p>I was talking to my friend <a target="_blank" rel="noopener" href="https://twitter.com/bolinchris?lang=en">Chris Bolin</a> about this question the other day and he mentioned a confounding factor: global variables.</p>
<p>What if your map and filter function write to, then read from a variable defined outside of the scope of the operators? Given the same interface or contract, the result of the operators would change based on their implementation details. Definitely not something you want to have happen!</p>
<p>(Also a description of why functions that can give different answers depending on the state of the world, a.k.a, impure functions, are a bad idea)</p>
<h3 id="they-aint-built-for-efficiency">They ain't built for efficiency</h3>
<p>Perhaps another reason Kotlin's list operators aren't that efficient is because they were never meant to be. As with all things performance related, it's not a problem until it's a problem. Which is to say, until you're in a situation where efficiency matters, who cares how many times you're running a for loop?</p>
<p><em>Maybe</em> Kotlin has a less efficient list type for small amounts of data, and a different list type for very large amounts of data? <em>Maybe</em> the language implementers made a conscious decision to separate efficient operations into their own special concept?</p>
<p>Next time, we'll take a look at the internals of <a target="_blank" rel="noopener" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.sequences/-sequence/index.html">Sequence</a> - a list type that does just that!</p>
</div><div id="disqus_thread"></div>
<script type="text/javascript">
	// Disqus
	
   /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
   var disqus_shortname = 'codysehl-blog'; // required: replace example with your forum shortname
   var disqus_disable_mobile = false;

   /* * * DON'T EDIT BELOW THIS LINE * * */
   (function() {
       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
       dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
</script>
<noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a target="_blank" rel="noopener" href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div>